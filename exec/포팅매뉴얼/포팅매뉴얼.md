# í¬íŒ…

# 1. ê°œìš”

ë³¸ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ë¥¼ ë‹¤ë¥¸ ê°œë°œ í™˜ê²½ì— í¬íŒ…í•˜ê±°ë‚˜ ìš´ì˜ ì„œë²„ì— ë°°í¬í•˜ê¸° ìœ„í•œ í™˜ê²½ì„¤ì •, ì˜ì¡´ì„± ë²„ì „ ë° ì„¤ì¹˜ ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

- ì£¼ìš” ê°œë°œ OS: Window 11, (EC2) Ubuntu 22.04.5 LTS
- CI/CD í™˜ê²½: Jenkins LTS ìµœì‹ ë²„ì „

# 2. ì„ í–‰ ìš”êµ¬ì‚¬í•­ (Prerequisites)

1. **Java 17**
    - OpenJDK 17 ê¶Œì¥
    - `JAVA_HOME` í™˜ê²½ë³€ìˆ˜ ì„¤ì • í•„ìš” (ë§í¬ ì°¸ê³  >  [[Java] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •í•˜ê¸°](https://velog.io/@bi-sz/Java-%ED%99%98%EA%B2%BD-%EB%B3%80%EC%88%98-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0))
2. **Gradle 8.12.1 ì´ìƒ**
    - Spring Boot ë¹Œë“œì— ì‚¬ìš©
3. **Node.js 22.14 ì´ìƒ**
    - React(landing) í”„ë¡œì íŠ¸ ë¹Œë“œ/ì‹¤í–‰ì— ì‚¬ìš©
4. **Python 3.11 ê¶Œì¥**
    - Flask(AI ë¶„ì„), Django(landing & diagnostics) ì„œë²„ ë™ì‘
    - `pip` ìµœì‹  ë²„ì „ ì‚¬ìš© ê¶Œì¥
5. **Android Studio ìµœì‹ **
    - Kotlin 1.9.x, AGP 8.5.x
    - minSdk 24, targetSdk 34, compileSdk 35

# 3. í´ë” êµ¬ì¡° ë° ì„¤ì¹˜, local í™˜ê²½ì—ì„œ ì‹¤í–‰

```
S12P21D101/
 â”£ ai/                 # ai 
 â”£ backend/            
 **|**  â”£ kkomdae          # Spring Boot  
 **|**	â”£ kkomdae_django   # Django
 **|**  â”— ****kkomdae_flask    **#** FastAPI
 â”£ frontend/ 
 **|**  â”£ kkomdae          # Android
 **|**  â”— ****kkomdae_landing  # landing
 â”£ laptop_test         # ìê°€ì§„ë‹¨ í”„ë¡œê·¸ë¨
 â”— ...
```

## 3.1. ë ˆí¬ì§€í† ë¦¬ í´ë¡  ë° ì´ë™

```bash
git clone https://lab.ssafy.com/s12-ai-image-sub1/S12P21D101.git
cd S12P21D101
```

## 3.2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •(.env)

### 3.2.1. Spring Boot (ìœ„ì¹˜ : backend/kkomdae/src/main/resources/.env)

```

# DB ê´€ë ¨
DB_URL=
DB_USERNAME=
DB_PW=8
DDL_AUTO=

# ì‹¸í”¼ ë¡œê·¸ì¸ ê´€ë ¨
REDIRECT_URI=
CLIENT_ID=
CLIENT_SECRET=
API_KEY=

JWT_SECRET=

# MM ê´€ë ¨
MATTERMOST_BASE_URL=
MATTERMOST_TEAM_ID=
MATTERMOST_CHANNEL_ID=

# S3 ì ‘ê·¼ ê´€ë ¨
S3_ACCESSKEY=
S3_SECRETKEY=
S3_BUCKETNAME=
S3_PREFIX=

# GPT ê´€ë ¨
OPENAI_KEY=
```

### 3.2.2. fastAPI(ìœ„ì¹˜ : backend/kkomdae_flask/.env)

```
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_REGION=
BUCKET_NAME=
S3_PREFIX=

OPENAI_KEY=
```

### 3.2.3. django (ìœ„ì¹˜ : backend/kkomdae_django/.env)

```
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_REGION=
BUCKET_NAME=
S3_PREFIX=
```

### 3.2.4. android studio (ìœ„ì¹˜: frontend/Kkomdae/Gradle Scripts/local.properties)

```jsx
## This file must *NOT* be checked into Version Control Systems,
# as it contains information specific to your local configuration.
#
# Location of the SDK. This is only used by Gradle.
# For customization when using a Version Control System, please read the
# header note.
#Fri Apr 04 17:34:42 KST 2025
sdk.dir=
SERVER_URL=
VISION_API_KEY=
```

## 3.3. ë¡œì»¬ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì‹¤í–‰

### **3.3.1. Frontend(React)**

```bash
cd frontend/kkmodae_landing
npm install
npm run dev
```

- Node.js 22.14
- React 19.0.0 ê¸°ë°˜
- Typescript 5.7.2
- Axios ^1.8.4
1. **Android**
    - Android Studioì—ì„œ `frontend/Kkomdae` ë””ë ‰í† ë¦¬ë¥¼ ì—´ê¸°
    - `libs.versions.toml`, `build.gradle.kts` ìë™ ë™ê¸°í™”(Gradle Sync)
    - Kotlin 1.9.23, AGP 8.5.1, minSdk 24, targetSdk 34, compileSdk 35
    - Hilt, Retrofit, CameraX, ML Kit ë“± ì˜ì¡´ì„±ì€ `build.gradle.kts` ì°¸ì¡°
    
    ---
    
    ![image.png](image.png)
    
    ![image.png](image%201.png)
    
    ![image.png](image%202.png)
    
    ![image.png](image%203.png)
    

### **3.3.2. Backend(Spring Boot)**

```bash
cd backend/Kkomdae
./gradlew clean build
# local í”„ë¡œí•„ë¡œ ì‹¤í–‰
java -jar build/libs/kkomdae-0.0.1-SNAPSHOT.jar --spring.profiles.active=local 

```

- Java 17, Gradle 8.12.1
- Spring Boot 3.4.3, Hibernate 6.6.8.Final
- Lombok, QueryDSL, iTextPDF ë“± í¬í•¨

### 3.3.3. Flaks (ai ë¶„ì„ ì„œë²„)

```bash
cd backend/kkomdae_flask
python -m venv venv # ê°€ìƒí™˜ê²½ ì„¤ì¹˜
source venv/Scripts/activate # ê°€ìƒí™˜ê²½ ì‹¤í–‰
pip install -r requirements.txt # ì˜ì¡´ì„± ì„¤ì¹˜
python app.py # ì„œë²„ ì‹¤í–‰
```

- Python 3.11 ê¶Œì¥

### **3.3.4. Django(landing & diagnostics)**

```bash
cd backend/kkomdae_django # backendí´ë” ë‚´ Django
python -m venv venv # ê°€ìƒí™˜ê²½ ì„¤ì¹˜
source venv/Scripts/activate # ê°€ìƒí™˜ê²½ ì‹¤í–‰
pip install -r requirements.txt # ì˜ì¡´ì„± ì„¤ì¹˜
python manage.py runserver # ì„œë²„ ì‹¤í–‰
```

- Django 5.1.7, python-dotenv, boto3, gunicorn ë“±
- Python 3.11 ê¶Œì¥

---

# 4. EC2 ì„¸íŒ… ë° ì„¤ì •

- ec2 ì¸ìŠ¤í„´ìŠ¤ êµ¬ì„± ë° ì ‘ì†ì„ ìˆ˜í–‰í–ˆë‹¤ëŠ” ê°€ì •ì—ì„œ ë©”ë‰´ì–¼ì„ ì‘ì„±í•œë‹¤.

## 4.1. Docker

### 4.1.1. Docker ì„¤ì¹˜

```bash
# ë„ì»¤ ì„¤ì¹˜
sudo apt-get update
sudo apt install apt-transport-https ca-certificates curl software-properties-common -y
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
#Docker version 28.0.1, build 068a01e
#ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ë„ì»¤ ì†Œì¼“ ì—°ê²°ì„ ìœ„í•œ ê¶Œí•œ ì„¤ì •
sudo usermod -aG docker $USER
newgrp docker
```

### 4.1.2 Docker-compose.yml ì„¸íŒ…

íŒŒì¼ ìœ„ì¹˜: /home/ubuntu/d-101/docker-compose.yml

```jsx
services:
  backend:
    image: dororo737/d-101:latest
    container_name: backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      TZ: Asia/Seoul
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:latest
    container_name: postgres
    restart: unless-stopped
    ports:
      - 54321:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1
      POSTGRES_DB: postgres
      TZ: Asia/Seoul
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  frontend:
    image: dororo737/d-101-front:latest
    container_name: frontend
    networks:
      - app-network
    restart: unless-stopped
    ports:
      - "127.0.0.1:8081:80"
    environment:
      TZ: Asia/Seoul

  django:
    image: dororo737/d-101-django:latest
    container_name: django
    networks:
      - app-network
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      TZ: Asia/Seoul

  flask:
    image: dororo737/d-101-flask:latest
    container_name: flask
    networks:
      - app-network
    restart: unless-stopped
    environment:
      TZ: Asia/Seoul

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:

```

## 4.2. PostgreSQL(Docker container) ì„¤ì¹˜

docker-compose.yml ì‹¤í–‰ ì‹œ ì„¤ì¹˜

`docker compose up -d`

## 4.3. Nginx

### 4.3.1. Nginxì„¤ì¹˜

```jsx
sudo apt update

# nginx ì„¤ì¹˜
sudo apt install nginx

# ìƒíƒœ í™•ì¸
sudo systemctl status nginx

# Certbot snap ì„¤ì¹˜í•˜ê¸°
sudo snap install --classic certbot

# Certbot ëª…ë ¹ì–´ ì‰½ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê²½ë¡œ ì„¤ì •
sudo ln -s /snap/bin/certbot /usr/bin/certbot

# HTTPS ì¸ì¦ì„œ ë°œê¸‰ë°›ê³  Nginx ìë™ ì„¤ì •
sudo certbot --nginx

# ì ‘ì† ì‹œ ì›°ì»´ í˜ì´ì§€ì™€ ì£¼ì†Œì°½ ì™¼ìª½ì— ìë¬¼ì‡ ê°€ ë³´ì¸ë‹¤ (ë³´ì•ˆì—°ê²°) 
https://...
```

### 4.3.2. Nginx ì„¤ì • (default íŒŒì¼)

ìœ„ì¹˜: `/etc/nginx/sites-available/default`

```jsx
server {
    listen 80;
    listen [::]:80;
    server_name j12d101.p.ssafy.io;

    # HTTPë¥¼ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name j12d101.p.ssafy.io;

    ssl_certificate /etc/letsencrypt/live/p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/p.ssafy.io/privkey.pem;

    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /var/www/html;
    index index.html index.htm index.nginx-debian.html;

    # Frontend í”„ë¡ì‹œ (ê¸°ë³¸ ê²½ë¡œ)
    location / {
        proxy_pass http://localhost:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Backend í”„ë¡ì‹œ
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Backend image í”„ë¡ì‹œ
    location /image/ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Jenkins í”„ë¡ì‹œ
    location /jenkins/ {
        proxy_pass http://localhost:18080;
        proxy_http_version 1.1;

        #ì—…ê·¸ë ˆì´ë“œ ë° í—¤ë” ì„¤ì •
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Jenkinsê°€ ë‚´ë¶€ì ìœ¼ë¡œ http:// ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ë•Œ
        # ì™¸ë¶€ì—ì„œëŠ” https://.../jenkins/ ë¡œ ì¸ì‹í•˜ë„ë¡ ì²˜ë¦¬
        proxy_redirect http://localhost:18080/jenkins/ https://j12d101.p.ssafy.io/jenkins/;
    }

    # django í”„ë¡ì‹œ
    location /django/{
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header Origin $http_origin;
    }
}

```

## 4.4. ë°©í™”ë²½(UFW) ì„¤ì •

- 22, 80, 443 í—ˆìš©

```jsx
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
sudo ufw status
```

```jsx
[ì°¸ê³ ] ufw ì ìš© ìˆœì„œ

ì œê³µë˜ëŠ” EC2ì˜ ufw(ìš°ë¶„íˆ¬ ë°©í™”ë²½)ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”(Enable) ë˜ì–´ ìˆê³ ,
ssh 22ë²ˆ í¬íŠ¸ë§Œ ì ‘ì† ê°€ëŠ¥í•˜ê²Œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

í¬íŠ¸ë¥¼ ì¶”ê°€í•  ê²½ìš° 6ë²ˆë¶€í„° ì°¸ê³ í•˜ì‹œê³ ,
ì²˜ìŒë¶€í„° ìƒˆë¡œ ì„¸íŒ…í•´ ë³´ì‹¤ ê²½ìš°ì—ëŠ” 1ë²ˆë¶€í„° ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

1. ì²˜ìŒ ufw ì„¤ì • ì‹œ ì‹¤ìˆ˜ë¡œ sshì ‘ì†ì´ ì•ˆë˜ëŠ” ê²½ìš°ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´
   ssh í„°ë¯¸ë„ì„ ì—¬ìœ ìˆê²Œ 2~3ê°œ ì—°ê²°í•´ ë†“ëŠ”ë‹¤.

2. ufw ìƒíƒœ í™•ì¸
$ sudo ufw status
Status : inactive

3. ì‚¬ìš©í•  í¬íŠ¸ í—ˆìš©í•˜ê¸° (ufw inactive ìƒíƒœ)
$ sudo ufw allow 22

3-1 ë“±ë¡í•œ í¬íŠ¸ ì¡°íšŒí•˜ê¸° (ufw inactive ìƒíƒœ)
$ sudo ufw show added
Added user rules (see 'ufw status' for running firewall):
ufw allow 22

4. ufw í™œì„±í™” í•˜ê¸°
$ sudo ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y

4.1 ufw ìƒíƒœ ë° ë“±ë¡ëœ rule í™•ì¸í•˜ê¸°
$ sudo ufw status numbered
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    Anywhere
[ 2] 22 (v6)                    ALLOW IN    Anywhere (v6)

5. ìƒˆë¡œìš´ í„°ë¯¸ë„ì„ ë„ì›Œ ssh ì ‘ì†í•´ ë³¸ë‹¤.
C:\> ssh -i íŒ€.pem ubuntu@íŒ€.p.ssafy.io

6. ufw êµ¬ë™ëœ ìƒíƒœì—ì„œ 80 í¬íŠ¸ ì¶”ê°€í•˜ê¸°
$ sudo ufw allow 80

6-1. 80 í¬íŠ¸ ì •ìƒ ë“±ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸°
$ sudo ufw status numbered
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    Anywhere
[ 2] 80                         ALLOW IN    Anywhere
[ 3] 22 (v6)                    ALLOW IN    Anywhere (v6)
[ 4] 80 (v6)                    ALLOW IN    Anywhere (v6)

6-2. allow ëª…ë ¹ì„ ìˆ˜í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ufwì— ë°˜ì˜ë˜ì–´ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤. 

7. ë“±ë¡í•œ 80 í¬íŠ¸ ì‚­ì œ í•˜ê¸°
$ sudo ufw status numbered
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    Anywhere
[ 2] 80                         ALLOW IN    Anywhere
[ 3] 22 (v6)                    ALLOW IN    Anywhere (v6)
[ 4] 80 (v6)                    ALLOW IN    Anywhere (v6)

7-1. ì‚­ì œí•  80 í¬íŠ¸ì˜ [ë²ˆí˜¸]ë¥¼ ì§€ì •í•˜ì—¬ ì‚­ì œí•˜ê¸°
      ë²ˆí˜¸ í•˜ë‚˜ì”© ì§€ì •í•˜ì—¬ ì‚­ì œí•œë‹¤.
$ sudo ufw delete 4
$ sudo ufw delete 2
$ sudo ufw status numbered  (ì œëŒ€ë¡œ ì‚­ì œí–ˆëŠ”ì§€ ì¡°íšŒí•´ë³´ê¸°)
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    Anywhere
[ 2] 22 (v6)                    ALLOW IN    Anywhere (v6)

7-2 (ì¤‘ìš”) ì‚­ì œí•œ ì •ì±…ì€ ë°˜ë“œì‹œ enableì„ ìˆ˜í–‰í•´ì•¼ ì ìš©ëœë‹¤.
$ sudo ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? yì…ë ¥

ê¸°íƒ€
- ufw ë„ê¸°
$ sudo ufw disable
```

## 4.5. Git Username/Password ì„¤ì •

## 4.6 Jenkins ì„¤ì¹˜ (Docker container)

```jsx
docker run -d \
  --name jenkins \
  --network d-101_app-network \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/bin/docker:/usr/bin/docker \
  -v jenkins-data:/var/jenkins_home \
  -p 127.0.0.1:18080:8080 \
  -e JENKINS_OPTS="--prefix=/jenkins" \
  jenkins/jenkins:lts
```

# 5. Jenkins ì„¤ì •

## 5.1. GitLab Credentials ì„¤ì •

## 5.2. Jenkins Item ìƒì„±

## 5.3. GitLab Webhook ì„¤ì •

## 5.4. ë¹Œë“œ ë° ë°°í¬

## 5.5. Jenkins Gradle + NodeJS ì„¤ì •

## 5.6 Jenkinsfile ì„¤ì •

```jsx
pipeline {
    agent any

    /////////////////////////////////////////////////////////////////////////
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    /////////////////////////////////////////////////////////////////////////
    environment {
        DOCKER_IMAGE_BACKEND  = "dororo737/d-101"        // Docker Hub (java spring)
        DOCKER_IMAGE_FRONTEND = "dororo737/d-101-front" // Docker Hub (landing)
        DOCKER_IMAGE_DJANGO = "dororo737/d-101-django" 
        DOCKER_IMAGE_FLASK = "dororo737/d-101-flask"
        DOCKER_TAG          = "latest"                 // íƒœê·¸
        REGISTRY_CREDENTIAL = "REGISTRY_CREDENTIAL"
        SSH_CREDENTIALS     = "SSH_CREDENTIALS"
        EC2_USER            = "ubuntu"
        EC2_HOST            = "j12d101.p.ssafy.io"
        DOCKER_COMPOSE_PATH = '/home/ubuntu/d-101'
    }

    //-----------------------------------------------------------------
    // Jenkinsê°€ ì‚¬ì „ì— ì„¤ì •í•´ë‘” tool ë§¤í•‘ (PATH êµ¬ì„±)
    //-----------------------------------------------------------------
    tools {
        jdk 'JDK17'
        gradle 'Gradle 8.12.1'
        nodejs 'NodeJS22' // Node.js 22 ë²„ì „ ì‚¬ìš©
    }

    /////////////////////////////////////////////////////////////////////////
    // íŒŒì´í”„ë¼ì¸ Stages
    /////////////////////////////////////////////////////////////////////////
    stages {
        // 1) Checkout ë° ë³€ê²½ ì²´í¬
        stage('Checkout & Diff Check') {
            steps {
                checkout scm
                script {
                    def diffCounts = [
                        backend: "backend/kkomdae",
                        django: "backend/kkomdae_django/",
                        flask: "backend/kkomdae_flask/",
                        landing: "frontend/kkomdae_landing/"
                    ]

                    diffCounts.each { key, path ->
                        def diffCount = sh(script: "git diff HEAD~1 HEAD --name-only | grep '^${path}' | wc -l", returnStdout: true).trim()
                        env."SKIP_${key.toUpperCase()}_BUILD" = (diffCount == '0') ? 'true' : 'false'
                        echo "${key.capitalize()} ë³€ê²½ ê±´ìˆ˜: ${diffCount} â†’ SKIP_${key.toUpperCase()}_BUILD=${env."SKIP_${key.toUpperCase()}_BUILD"}"
                    }
                }
            }
        }
        // 2) ë³‘ë ¬ ë¹Œë“œ ë‹¨ê³„
        stage('Build & Push') {
            parallel {

                // 2-1) ë°±ì—”ë“œ ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
                stage('Backend Build & Docker Build/Push') {
                    when { expression { return env.SKIP_BACKEND_BUILD != 'true' } }
                    steps {
                        // Jenkins Credentialsì— ë“±ë¡ëœ .env íŒŒì¼ì„ ê°€ì ¸ì˜´
                        withCredentials([file(credentialsId: '.env', variable: 'env')]) {
                            sh '''
                                rm -f backend/kkomdae/src/main/resources/.env
                                mkdir -p backend/kkomdae/src/main/resources
                                cp "$env" backend/kkomdae/src/main/resources/.env
                                cat backend/kkomdae/src/main/resources/.env
                            '''
                        }
                        // backend/kkomdae ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ ë° Docker ì‘ì—… ì§„í–‰
                        dir('backend/kkomdae') {
                            // Gradle ë¹Œë“œ
                            sh '''
                            chmod +x gradlew
                            ./gradlew clean build -Dspring.profiles.active=prod
                            '''
                            // JAR íŒŒì¼ì„ Dockerfile ê²½ë¡œë¡œ ë³µì‚¬
                            sh 'cp build/libs/kkomdae-0.0.1-SNAPSHOT.jar ./app.jar'

                            // Docker ë¹Œë“œ ë° í‘¸ì‹œ
                            script {
                                docker.withRegistry('https://index.docker.io/v1/', REGISTRY_CREDENTIAL) {
                                    def app = docker.build("${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}")
                                    sh 'docker info'
                                    app.push()
                                }
                            }
                        }
                    }
                }

                // 2-2) í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
                stage('Landing Build & Docker Build/Push') {
                    when { expression { return env.SKIP_LANDING_BUILD != 'true' } }
                    steps {
                        dir('frontend/kkomdae_landing') {
                            sh 'npm install'
                            sh 'npm run build'
                            script {
                                docker.withRegistry('https://index.docker.io/v1/', REGISTRY_CREDENTIAL) {
                                    def app = docker.build("${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}")
                                    sh 'docker info'
                                    app.push()
                                }
                            }
                        }
                    }
                }

                // 2-3) Django ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
                stage('Django Build & Docker Build/Push') {
                    when { expression { return env.SKIP_DJANGO_BUILD != 'true' } }
                    steps {
                        // Jenkins Credentialsì— ë“±ë¡ëœ .env íŒŒì¼ì„ ê°€ì ¸ì˜´
                        withCredentials([file(credentialsId: 'Django.env', variable: 'env')]) {
                            sh '''
                                rm -f backend/kkomdae_django/.env
                                cp "$env" backend/kkomdae_django/.env
                                cat backend/kkomdae_django/.env
                            '''
                        }
                        // backend/kkomdae_django ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ ë° Docker ì‘ì—… ì§„í–‰
                        dir('backend/kkomdae_django') {
                            script {
                                docker.withRegistry('https://index.docker.io/v1/', REGISTRY_CREDENTIAL) {
                                    def app = docker.build("${DOCKER_IMAGE_DJANGO}:${DOCKER_TAG}")
                                    sh 'docker info'
                                    app.push()
                                }
                            }        
                        }
                    }
                }
                
                // 2-4) Flask ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
                stage('Flask Build & Docker Build/Push') {
                    when { expression { return env.SKIP_FLASK_BUILD != 'true' } }
                    steps {
                        // Jenkins Credentialsì— ë“±ë¡ëœ .env íŒŒì¼ì„ ê°€ì ¸ì˜´
                        withCredentials([file(credentialsId: 'Flask.env', variable: 'env')]) {
                            sh '''
                                rm -f backend/kkomdae_flask/.env
                                cp "$env" backend/kkomdae_flask/.env
                                cat backend/kkomdae_flask/.env
                            '''
                        }
                        // backend/kkomdae_flask ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ ë° Docker ì‘ì—… ì§„í–‰
                        dir('backend/kkomdae_flask') {
                            script {
                                docker.withRegistry('https://index.docker.io/v1/', REGISTRY_CREDENTIAL) {
                                    def app = docker.build("${DOCKER_IMAGE_FLASK}:${DOCKER_TAG}")
                                    sh 'docker info'
                                    app.push()
                                }
                            }        
                        }
                    }
                }
            }
        }
    

        // 3) Deploy ë‹¨ê³„: ì›ê²© ì„œë²„ì—ì„œ docker-composeë¥¼ ì´ìš©í•´ ë°°í¬
        stage('Deploy') {
            when { expression { return env.SKIP_BACKEND_BUILD != 'true' || env.SKIP_LANDING_BUILD != 'true' || env.SKIP_DJANGO_BUILD != 'true' || env.SKIP_FLASK_BUILD != 'true' } }
            steps {
                echo "[Deploy] Deploying to ${EC2_HOST} as ${EC2_USER}"
                sshagent(credentials: ['SSH_CREDENTIALS']) {
                sh """
                    ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} /bin/bash <<EOS
    cd "${DOCKER_COMPOSE_PATH}"
    docker compose pull
    docker compose up -d --force-recreate
    docker system prune -f
    sleep 5
    docker ps || echo "Container check failed"
EOS
                """
                }
            }
        }
    }

    /////////////////////////////////////////////////////////////////////////
    // ë¹Œë“œ í›„ ì•Œë¦¼ ì„¤ì •
    /////////////////////////////////////////////////////////////////////////
    post {
        success {
            script {
                def Author_ID    = sh(script: "git log -1 --pretty=%an", returnStdout: true).trim()
                def Author_Email = sh(script: "git log -1 --pretty=%ae", returnStdout: true).trim()
                mattermostSend(
                    color: 'good',
                    message: """\
âœ… ë¹Œë“œ ì„±ê³µ: ${env.JOB_NAME} #${env.BUILD_NUMBER}
ì‘ì„±ì: ${Author_ID} (${Author_Email})
(&lt;${env.BUILD_URL}|ìƒì„¸ë³´ê¸°&gt;)
""",
                    endpoint: 'https://meeting.ssafy.com/hooks/awheadganfnkjqc33r48z8xceo',
                    channel: '[ğŸ””ì•Œë¦¼] ê¼¼ëŒ€[ğŸ””ì•Œë¦¼] ê¼¼ëŒ€'
                )
            }
        }
        failure {
            script {
                def Author_ID    = sh(script: "git log -1 --pretty=%an", returnStdout: true).trim()
                def Author_Email = sh(script: "git log -1 --pretty=%ae", returnStdout: true).trim()
                mattermostSend(
                    color: 'danger',
                    message: """\
âŒ ë¹Œë“œ ì‹¤íŒ¨: ${env.JOB_NAME} #${env.BUILD_NUMBER}
ì‘ì„±ì: ${Author_ID} (${Author_Email})
(&lt;${env.BUILD_URL}|ìƒì„¸ë³´ê¸°&gt;)
""",
                    endpoint: 'https://meeting.ssafy.com/hooks/awheadganfnkjqc33r48z8xceo',
                    channel: '[ğŸ””ì•Œë¦¼] ê¼¼ëŒ€[ğŸ””ì•Œë¦¼] ê¼¼ëŒ€'
                )
            }
        }
    }
}

```

# 9. ì™¸ë¶€ì„œë¹„ìŠ¤ ì—°ë™

## 9.1. ì†Œì…œ ë¡œê·¸ì¸ - ssafy

### 9.1.1. ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±

### 9.1.2. í‚¤ ìƒì„±, ë™ì˜ í•­ëª© ì„ íƒ

### 9.1.3. application-oauth.yml ì‘ì„±

### 9.1.4. ì‚¬ìš©ì ì •ë³´ ì–»ì–´ì˜¤ê¸°

---

## 10. **ê³µì‹ ë¬¸ì„œ**

- [Node.js Releases](https://nodejs.org/)
- [Android Developers](https://developer.android.com/)
- [Spring Boot Docs](https://spring.io/projects/spring-boot)
- [Django Docs](https://docs.djangoproject.com/en/)
- [Flask Docs](https://flask.palletsprojects.com/en/stable/)